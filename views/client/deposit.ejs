<div class="max-w-7xl mx-auto">
    <div class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-xl">
        <div class="p-6 border-b border-slate-800 bg-slate-900/50">
            <h3 class="text-xl font-bold text-white tracking-tight">Nạp tiền tài khoản</h3>
            <p class="text-slate-400 text-sm mt-1">Chọn phương thức nạp tiền phù hợp với bạn</p>
        </div>

        <div class="p-8 grid grid-cols-1 lg:grid-cols-2">
            <!-- Left Column: Transfer Info -->
            <div class="lg:border-r lg:border-slate-800 lg:pr-12">
                <div class="flex items-center justify-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-400">
                        <i class="ri-bank-card-line text-xl"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold text-white">Cách 1: Chuyển khoản ngân hàng</h4>
                        <p class="text-xs text-slate-400">Chuyển khoản thủ công theo thông tin bên dưới</p>
                    </div>
                </div>


                <div class="space-y-4">
                    <!-- Bank Name -->
                    <div
                        class="bg-slate-950/50 border border-slate-800/50 rounded-xl p-4 flex items-center justify-between group hover:border-indigo-500/30 transition">
                        <div>
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Ngân hàng</p>
                            <p class="text-base font-bold text-white" id="bankName">
                                <%= bank.name %>
                            </p>
                        </div>
                        <button onclick="copyToClipboard('<%= bank.name %>')"
                            class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition"
                            title="Copy">
                            <i class="ri-file-copy-line text-lg w-5 h-5 flex items-center justify-center"></i>
                        </button>
                    </div>

                    <!-- Account Number -->
                    <div
                        class="bg-slate-950/50 border border-slate-800/50 rounded-xl p-4 flex items-center justify-between group hover:border-indigo-500/30 transition">
                        <div>
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Số tài khoản</p>
                            <p class="text-lg font-mono font-bold text-emerald-400 tracking-wide" id="bankAccount">
                                <%= bank.account %>
                            </p>
                        </div>
                        <button onclick="copyToClipboard('<%= bank.account %>')"
                            class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition"
                            title="Copy">
                            <i class="ri-file-copy-line text-lg w-5 h-5 flex items-center justify-center"></i>
                        </button>
                    </div>

                    <!-- Account Holder -->
                    <div
                        class="bg-slate-950/50 border border-slate-800/50 rounded-xl p-4 flex items-center justify-between group hover:border-indigo-500/30 transition">
                        <div>
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Chủ tài khoản</p>
                            <p class="text-base font-bold text-white uppercase">
                                <%= bank.holder %>
                            </p>
                        </div>
                        <button onclick="copyToClipboard('<%= bank.holder %>')"
                            class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition"
                            title="Copy">
                            <i class="ri-file-copy-line text-lg w-5 h-5 flex items-center justify-center"></i>
                        </button>
                    </div>

                    <!-- Transfer Content -->
                    <div
                        class="bg-indigo-900/10 border border-indigo-500/20 rounded-xl p-4 flex items-center justify-between group hover:bg-indigo-900/20 transition relative overflow-hidden">
                        <div class="pl-2">
                            <p class="text-xs font-bold text-indigo-300 uppercase tracking-widest mb-1">Nội dung chuyển
                                tiền <span class="text-rose-400">*</span></p>
                            <p class="text-lg font-mono font-bold text-white tracking-wide">
                                <%= bank.syntax %>
                            </p>
                        </div>
                        <button onclick="copyToClipboard('<%= bank.syntax %>')"
                            class="p-2 text-indigo-300 hover:text-white hover:bg-indigo-500/30 rounded-lg transition"
                            title="Copy">
                            <i class="ri-file-copy-line text-lg w-5 h-5 flex items-center justify-center"></i>
                        </button>
                    </div>
                </div>

                <div
                    class="mt-6 bg-amber-500/10 border border-amber-500/20 rounded-xl p-4 flex items-center gap-3 text-amber-400">
                    <i class="ri-error-warning-line text-xl w-5 h-5 flex items-center justify-center"></i>
                    <span class="text-sm font-medium">Lưu ý: Nhập đúng nội dung chuyển khoản để được cộng tiền tự
                        động.</span>
                </div>
            </div>

            <!-- Right Column: QR Code -->
            <div class="flex flex-col items-center lg:pl-12">
                <div class="flex items-center justify-center gap-3 mb-6 w-full">
                    <div class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-400">
                        <i class="ri-qr-code-line text-xl"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold text-white">Cách 2: Quét mã QR</h4>
                        <p class="text-xs text-slate-400">Mở App Ngân hàng để quét mã</p>
                    </div>
                </div>

                <div class="w-full max-w-sm">
                    <div class="aspect-square bg-slate-100 rounded-xl overflow-hidden relative group">
                        <!-- VietQR Image -->
                        <img src="https://img.vietqr.io/image/<%= bank.name %>-<%= bank.account %>-compact.jpg?amount=0&addInfo=<%= encodeURIComponent(bank.syntax) %>&accountName=<%= encodeURIComponent(bank.holder) %>"
                            alt="VietQR Code" class="w-full h-full object-contain mix-blend-multiply"
                            onerror="this.src='/images/qr-placeholder.png'; this.parentElement.innerHTML+='<div class=\'absolute inset-0 flex items-center justify-center text-slate-500 text-xs\'>QR Error</div>'">

                        <div class="absolute inset-0 bg-black/5 group-hover:bg-transparent transition"></div>
                    </div>

                </div>

                <div
                    class="mt-8 flex items-center justify-center gap-5 px-6 py-4 bg-slate-800/30 rounded-2xl border border-slate-800/50">
                    <div class="relative flex items-center justify-center flex-shrink-0">
                        <div class="absolute inset-0 bg-indigo-500/20 blur-lg rounded-full"></div>
                        <svg class="animate-spin h-8 w-8 text-indigo-500 relative z-10"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                    </div>
                    <p class="text-slate-400 text-sm leading-relaxed text-left">
                        Hệ thống sẽ tự động cập nhật số dư<br>sau <span class="text-indigo-400 font-bold">1-3
                            phút</span> khi nhận được tiền.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast"
    class="fixed bottom-5 right-5 bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
    <div class="bg-emerald-500/20 text-emerald-400 p-1.5 rounded-lg">
        <i class="ri-check-line w-4 h-4 flex items-center justify-center"></i>
    </div>
    <span class="text-sm font-medium">Đã sao chép vào bộ nhớ tạm!</span>
</div>

<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast();
        }).catch(err => {
            console.error('Failed to copy: ', err);
        });
    }

    function showToast() {
        const toast = document.getElementById('toast');
        toast.classList.remove('translate-y-20', 'opacity-0');

        setTimeout(() => {
            toast.classList.add('translate-y-20', 'opacity-0');
        }, 3000);
    }

    // Auto Check Balance
    let currentBalance = <%= user.balance %>;

    setInterval(async () => {
        try {
            const response = await fetch('/balance');
            const data = await response.json();

            if (data.balance > currentBalance) {
                const diff = data.balance - currentBalance;
                currentBalance = data.balance;

                // Show Success Toast
                showBalanceToast(diff);

                // Update Sidebar Balance (optional, if you can target it)
                // Reloading page might be easier to update everything, but toast is nicer
                // Let's reload after a delay or just update the UI?
                // Request said "hiện toast thông báo", let's strictly do that.
                // Updating sidebar number would be nice too.
                const balanceElements = document.querySelectorAll('.font-mono'); // Basic selector logic
                // Actually layout uses formatted currency. We can reload or just notify.
                // Let's just notify for now as requested.
            }
        } catch (e) {
            console.error('Balance check failed', e);
        }
    }, 10000);

    function showBalanceToast(amount) {
        const formattedAmount = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);

        const toastHtml = `
            <div id="balance-toast" class="fixed top-5 right-5 bg-slate-900 border border-emerald-500/50 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 transform -translate-y-20 opacity-0 transition-all duration-500 z-50">
                <div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                    <i class="ri-checkbox-circle-fill text-2xl w-6 h-6 flex items-center justify-center"></i>
                </div>
                <div>
                    <h4 class="font-bold text-lg text-emerald-400">Nạp tiền thành công!</h4>
                    <p class="text-sm text-slate-300">Bạn vừa nhận được <span class="font-bold text-white">${formattedAmount}</span></p>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', toastHtml);

        const toast = document.getElementById('balance-toast');
        // Animate In
        requestAnimationFrame(() => {
            toast.classList.remove('-translate-y-20', 'opacity-0');
        });

        // Remove after 5s
        setTimeout(() => {
            toast.classList.add('-translate-y-20', 'opacity-0');
            setTimeout(() => toast.remove(), 500);
        }, 5000);
    }
</script>