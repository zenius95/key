<!-- Toolbar -->
<div
    class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 bg-slate-900/50 p-1.5 rounded-2xl border border-slate-800/50 backdrop-blur-sm shadow-sm">
    <div class="relative w-full sm:flex-1">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="ri-search-line text-slate-500 text-lg"></i>
        </div>
        <input type="text" id="productSearch" placeholder="Tìm kiếm sản phẩm..."
            class="bg-transparent border-none text-slate-200 text-sm rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/50 block w-full pl-10 p-2.5 placeholder-slate-500 transition duration-200">
    </div>

    <div class="flex items-center gap-2 w-full sm:w-auto">
        <% if (user.role==='admin' ) { %>
            <button onclick="openModal()"
                class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2.5 rounded-xl transition shadow-lg shadow-indigo-500/20 text-sm font-medium whitespace-nowrap flex items-center gap-2">
                <i class="ri-add-line"></i>
                Thêm sản phẩm
            </button>
            <% } %>
    </div>
</div>

<!-- Products Table -->
<div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-sm flex flex-col">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead class="bg-slate-850 text-[10px] uppercase text-slate-400 font-semibold border-b border-slate-800">
                <tr>
                    <th class="px-6 py-4 tracking-wider">Tên sản phẩm</th>
                    <th class="px-6 py-4 tracking-wider">Mô tả</th>
                    <th class="px-6 py-4 text-center tracking-wider">Gói</th>
                    <th class="px-6 py-4 tracking-wider">Trạng thái</th>
                    <% if (user.role==='admin' ) { %>
                        <th class="px-6 py-4 text-right tracking-wider">Thao tác</th>
                        <% } %>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-800 text-sm">
                <% products.forEach(function(p) { %>
                    <tr class="hover:bg-slate-800/50 transition duration-150 product-row">
                        <td class="px-6 py-4 font-medium text-slate-200">
                            <%= p.name %>
                        </td>
                        <td class="px-6 py-4 text-slate-400 max-w-xs truncate" title="<%= p.description %>">
                            <%= p.description || '-' %>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span
                                class="bg-slate-800 text-indigo-400 px-2.5 py-0.5 rounded-full text-xs font-bold border border-slate-700 shadow-sm">
                                <%= p.packages ? p.packages.length : 0 %>
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span
                                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium <%= p.status === 'inactive' ? 'bg-rose-500/10 text-rose-400 border border-rose-500/20' : 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' %>">
                                <%= p.status==='inactive' ? 'Ngừng' : 'Hoạt động' %>
                            </span>
                        </td>
                        <% if (user.role==='admin' ) { %>
                            <td class="px-6 py-4 text-right">
                                <div class="flex items-center justify-end gap-2">
                                    <button onclick="openModal(JSON.parse(this.getAttribute('data-product')))"
                                        data-product="<%= JSON.stringify(p).replace(/" /g, '&quot;' ) %>"
                                        class="p-1.5 rounded-lg text-slate-400 hover:text-indigo-400 hover:bg-slate-800
                                        transition"
                                        title="Edit">
                                        <i class="ri-edit-line"></i>
                                    </button>
                                    <a href="/products/delete/<%= p.id %>"
                                        onclick="return confirm('Xóa sản phẩm này và tất cả các gói liên quan?')"
                                        class="p-1.5 rounded-lg text-slate-400 hover:text-rose-400 hover:bg-slate-800 transition"
                                        title="Delete">
                                        <i class="ri-delete-bin-line"></i>
                                    </a>
                                </div>
                            </td>
                            <% } %>
                    </tr>
                    <% }); %>
                        <% if (products.length===0) { %>
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-slate-500">
                                    <p>Không tìm thấy sản phẩm nào.</p>
                                </td>
                            </tr>
                            <% } %>
            </tbody>
        </table>
    </div>
</div>

<script>
    document.getElementById('productSearch').addEventListener('keyup', function (e) {
        const term = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('.product-row');
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
        });
    });
</script>

<% if (user.role==='admin' ) { %>
    <!-- Product Modal -->
    <div id="productModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div
                    class="relative transform overflow-hidden rounded-xl bg-slate-900 border border-slate-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
                    <div class="px-6 py-5 border-b border-slate-800 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white" id="modalTitle">Thêm sản phẩm</h3>
                        <button type="button" onclick="closeModal()" class="text-slate-400 hover:text-white transition">
                            <i class="ri-close-line text-xl"></i>
                        </button>
                    </div>

                    <form id="productForm" onsubmit="saveProduct(event)" class="p-6 space-y-6">
                        <input type="hidden" id="p_id" name="id">

                        <!-- Product Basic Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Tên sản phẩm</label>
                                    <input type="text" id="p_name" required
                                        class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Trạng thái</label>
                                    <select id="p_status"
                                        class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                                        <option value="active">Hoạt động</option>
                                        <option value="inactive">Ngừng</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-1.5">Mô tả</label>
                                <textarea id="p_desc" rows="4"
                                    class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50"></textarea>
                            </div>
                        </div>

                        <!-- Discount Config -->
                        <div class="bg-slate-950/50 rounded-xl p-4 border border-slate-800">
                            <h4 class="text-sm font-bold text-slate-300 uppercase tracking-wider mb-4">Cấu hình giảm giá
                                (%)</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-400 mb-1">3 Tháng</label>
                                    <input type="number" id="discount_3m" value="5" min="0" max="100"
                                        class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-white text-sm text-center">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-400 mb-1">6 Tháng</label>
                                    <input type="number" id="discount_6m" value="8" min="0" max="100"
                                        class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-white text-sm text-center">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-400 mb-1">1 Năm</label>
                                    <input type="number" id="discount_1y" value="15" min="0" max="100"
                                        class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-white text-sm text-center">
                                </div>
                            </div>
                        </div>

                        <!-- Packages Section -->
                        <div class="bg-slate-950/50 rounded-xl p-4 border border-slate-800">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-sm font-bold text-slate-300 uppercase tracking-wider">Cấu hình gói dịch
                                    vụ</h4>
                                <button type="button" onclick="addPackageRow()"
                                    class="text-xs bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400 px-3 py-1.5 rounded-lg border border-indigo-500/20 transition flex items-center gap-1 font-medium">
                                    <i class="ri-add-line"></i> Thêm gói
                                </button>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead
                                        class="text-xs text-slate-500 font-semibold uppercase bg-slate-900/50 border-b border-slate-800">
                                        <tr>
                                            <th class="px-3 py-2 w-1/3">Tên gói</th>
                                            <th class="px-3 py-2 w-1/4">Số lượng UID (0 = Vô hạn)</th>
                                            <th class="px-3 py-2 w-1/4">Giá / Tháng (VND)</th>
                                            <th class="px-3 py-2 w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="packagesList" class="divide-y divide-slate-800">
                                        <!-- JS injected -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="noPackagesMsg" class="text-center py-6 text-slate-500 italic text-xs hidden">Chưa
                                có gói nào. Nhấn "Thêm gói" để bắt đầu.</div>
                        </div>

                        <div class="pt-2 flex justify-end gap-3 border-t border-slate-800 mt-4 pt-4">
                            <button type="button" onclick="closeModal()"
                                class="px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 transition">Hủy</button>
                            <button type="submit"
                                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-medium shadow-lg shadow-indigo-500/20 flex items-center gap-2 transition">
                                <svg id="saveSpinner" class="animate-spin h-4 w-4 text-white hidden"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                Lưu sản phẩm
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPackages = [];

        function openModal(product = null) {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('modalTitle');

            document.getElementById('p_id').value = '';
            document.getElementById('p_name').value = '';
            document.getElementById('p_desc').value = '';
            document.getElementById('p_status').value = 'active';

            // Reset discounts
            document.getElementById('discount_3m').value = 5;
            document.getElementById('discount_6m').value = 8;
            document.getElementById('discount_1y').value = 15;

            currentPackages = [];

            if (product) {
                title.innerText = 'Sửa sản phẩm: ' + product.name;
                document.getElementById('p_id').value = product.id;
                document.getElementById('p_name').value = product.name;
                document.getElementById('p_desc').value = product.description || '';
                document.getElementById('p_status').value = product.status || 'active';

                if (product.discount_config) {
                    const cfg = typeof product.discount_config === 'string' ? JSON.parse(product.discount_config) : product.discount_config;
                    document.getElementById('discount_3m').value = cfg.month3 || 0;
                    document.getElementById('discount_6m').value = cfg.month6 || 0;
                    document.getElementById('discount_1y').value = cfg.year1 || 0;
                }

                if (product.packages) {
                    currentPackages = JSON.parse(JSON.stringify(product.packages));
                }
            } else {
                title.innerText = 'Thêm sản phẩm mới';
            }

            renderPackages();
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('productModal').classList.add('hidden');
        }

        function renderPackages() {
            const tbody = document.getElementById('packagesList');
            const msg = document.getElementById('noPackagesMsg');
            tbody.innerHTML = '';

            if (currentPackages.length === 0) {
                msg.classList.remove('hidden');
            } else {
                msg.classList.add('hidden');
                currentPackages.forEach((pkg, index) => {
                    const row = document.createElement('tr');
                    row.className = 'group hover:bg-slate-900/50';
                    row.innerHTML = `
                        <td class="px-3 py-2">
                            <input type="text" value="${pkg.name || ''}" onchange="updatePackage(${index}, 'name', this.value)" class="w-full bg-transparent border-b border-transparent focus:border-indigo-500 focus:outline-none text-white text-sm py-1 placeholder-slate-600" placeholder="Tên gói" required>
                        </td>
                        <td class="px-3 py-2">
                            <input type="number" value="${pkg.max_uids !== undefined ? pkg.max_uids : 1}" onchange="updatePackage(${index}, 'max_uids', this.value)" class="w-full bg-transparent border-b border-transparent focus:border-indigo-500 focus:outline-none text-white text-sm py-1 text-center" placeholder="1" min="0">
                        </td>
                        <td class="px-3 py-2">
                            <input type="number" value="${pkg.original_price || ''}" onchange="updatePackage(${index}, 'original_price', this.value)" class="w-full bg-transparent border-b border-transparent focus:border-indigo-500 focus:outline-none text-white text-sm py-1 text-center" placeholder="0" required>
                        </td>
                        <td class="px-3 py-2 text-right">
                            <button type="button" onclick="removePackage(${index})" class="text-slate-600 hover:text-rose-500 transition p-1">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        function addPackageRow() {
            currentPackages.push({ id: null, name: '', max_uids: 1, original_price: 0 });
            renderPackages();
        }

        function updatePackage(index, field, value) {
            currentPackages[index][field] = value;
        }

        function removePackage(index) {
            currentPackages.splice(index, 1);
            renderPackages();
        }

        async function saveProduct(e) {
            e.preventDefault();
            const btn = e.submitter;
            const spinner = document.getElementById('saveSpinner');

            btn.disabled = true;
            spinner.classList.remove('hidden');

            const payload = {
                id: document.getElementById('p_id').value || null,
                name: document.getElementById('p_name').value,
                description: document.getElementById('p_desc').value,
                status: document.getElementById('p_status').value,
                discount_config: {
                    month3: parseInt(document.getElementById('discount_3m').value) || 0,
                    month6: parseInt(document.getElementById('discount_6m').value) || 0,
                    year1: parseInt(document.getElementById('discount_1y').value) || 0
                },
                packages: currentPackages.map(p => ({
                    id: p.id,
                    name: p.name,
                    max_uids: parseInt(p.max_uids),
                    original_price: parseFloat(p.original_price || p.price), // Handle potential legacy key
                }))
            };

            try {
                const res = await fetch('/products/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.message || 'Error saving product');
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                }
            } catch (err) {
                console.error(err);
                alert('Network error');
                btn.disabled = false;
                spinner.classList.add('hidden');
            }
        }
    </script>
    <% } %>