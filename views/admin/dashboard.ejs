<!-- Minimalist & Functional Dashboard (V10) -->
<div class="space-y-8">
    <!-- Clean Header -->
    <div class="border-b border-slate-800/60 pb-6 flex justify-between items-end">
        <div>
            <h1 class="text-2xl font-bold text-white tracking-tight">Thống kê hệ thống</h1>
            <p class="text-slate-500 text-xs mt-1">Phân tích tăng trưởng và hiệu suất kinh doanh.</p>
        </div>
        <div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-slate-900/80 rounded-full border border-slate-800">
            <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Hệ thống đang hoạt động</span>
        </div>
    </div>

    <!-- Stats Table Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <% const periods=[ { key: 'today' , label: 'Hôm nay' , color: 'indigo' }, { key: 'month' , label: 'Tháng này' ,
            color: 'emerald' }, { key: 'quarter' , label: 'Quý này' , color: 'amber' }, { key: 'all' , label: 'Tất cả' ,
            color: 'slate' } ]; %>

            <% periods.forEach(period=> { %>
                <div
                    class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 hover:bg-slate-800/40 transition-all duration-300 group">
                    <!-- Period Label & Range -->
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-1.5">
                            <div
                                class="w-1 h-3 rounded-full bg-<%= period.color === 'slate' ? 'slate-500' : period.color + '-500' %> group-hover:scale-y-125 transition-transform">
                            </div>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                <%= period.label %>
                            </span>
                        </div>
                        <div class="flex items-center gap-1.5 ml-3">
                            <i class="ri-bar-chart-fill text-slate-600 text-xs"></i>
                            <p class="text-[9px] text-slate-500 font-medium font-mono uppercase tracking-tighter">
                                <%= stats[period.key].range %>
                            </p>
                        </div>
                    </div>

                    <!-- Stats List -->
                    <div class="space-y-6">
                        <!-- Revenue Section -->
                        <div>
                            <p class="text-[9px] text-slate-400 uppercase font-bold mb-1 tracking-tight">Doanh thu dự
                                kiến</p>
                            <div class="flex items-baseline gap-2">
                                <p class="text-2xl font-bold text-white tracking-tight">
                                    <%= new Intl.NumberFormat('vi-VN', { style: 'currency' , currency: 'VND' ,
                                        maximumFractionDigits: 0 }).format(stats[period.key].revenue) %>
                                </p>
                                <% if (period.key !=='all' ) { %>
                                    <div
                                        class="flex items-center gap-0.5 px-1.5 py-0.5 rounded-md <%= stats[period.key].growth.revenue >= 0 ? 'bg-emerald-500/10 text-emerald-500' : 'bg-rose-500/10 text-rose-500' %>">
                                        <span class="text-[9px] font-black">
                                            <%= stats[period.key].growth.revenue>= 0 ? '↑' : '↓' %>
                                        </span>
                                        <span class="text-[10px] font-bold">
                                            <%= Math.abs(stats[period.key].growth.revenue) %>%
                                        </span>
                                    </div>
                                    <% } %>
                            </div>
                        </div>

                        <!-- Counter Grid -->
                        <div class="grid grid-cols-2 gap-4 pt-5 border-t border-slate-800/40">
                            <div>
                                <p class="text-[8px] text-slate-500 uppercase font-black mb-1">Người dùng</p>
                                <div class="flex items-baseline gap-1.5">
                                    <p class="text-lg font-bold text-white/90">
                                        <%= stats[period.key].users %>
                                    </p>
                                    <% if (period.key !=='all' ) { %>
                                        <span
                                            class="text-[9px] font-bold <%= stats[period.key].growth.users >= 0 ? 'text-emerald-500' : 'text-rose-500' %>">
                                            <%= stats[period.key].growth.users>= 0 ? '+' : '' %><%=
                                                    stats[period.key].growth.users %>%
                                        </span>
                                        <% } %>
                                </div>
                            </div>
                            <div>
                                <p class="text-[8px] text-slate-500 uppercase font-black mb-1">Đơn hàng</p>
                                <div class="flex items-baseline gap-1.5">
                                    <p class="text-lg font-bold text-white/90">
                                        <%= stats[period.key].orders %>
                                    </p>
                                    <% if (period.key !=='all' ) { %>
                                        <span
                                            class="text-[9px] font-bold <%= stats[period.key].growth.orders >= 0 ? 'text-emerald-500' : 'text-rose-500' %>">
                                            <%= stats[period.key].growth.orders>= 0 ? '+' : '' %><%=
                                                    stats[period.key].growth.orders %>%
                                        </span>
                                        <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% }) %>
    </div>

    <!-- Revenue Chart Section -->
    <div class="bg-slate-900/50 border border-slate-800 rounded-3xl p-8 mt-12 relative overflow-hidden group/chart">
        <!-- Decoration Area -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-600/5 blur-[120px] rounded-full -mr-32 -mt-32"></div>

        <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10 relative z-10">
            <div>
                <div class="flex items-center gap-3 mb-1">
                    <h3 class="text-xl font-bold text-white">Biểu đồ doanh thu</h3>
                    <div id="chart-range-badge"
                        class="px-2.5 py-1 bg-indigo-500/10 border border-indigo-500/20 rounded-full flex items-center gap-1.5">
                        <div class="w-1 h-1 rounded-full bg-indigo-500"></div>
                        <span id="chart-date-range"
                            class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider">Đang tính
                            toán...</span>
                    </div>
                </div>
                <p class="text-slate-500 text-[10px] uppercase font-bold tracking-[0.2em]">Phân tích tài chính thông
                    minh</p>
            </div>

            <div class="flex bg-slate-950/80 p-1.5 rounded-2xl border border-slate-800 shadow-xl">
                <button onclick="updateRevenueChart('month')" id="btn-month"
                    class="px-5 py-2 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all chart-filter-btn active">Tháng</button>
                <button onclick="updateRevenueChart('quarter')" id="btn-quarter"
                    class="px-5 py-2 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all chart-filter-btn text-slate-500 hover:text-indigo-400">Quý</button>
                <button onclick="updateRevenueChart('year')" id="btn-year"
                    class="px-5 py-2 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all chart-filter-btn text-slate-500 hover:text-indigo-400">Năm</button>
            </div>
        </div>

        <div class="relative h-[400px] w-full z-10">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let revenueChart;

    async function updateRevenueChart(type) {
        // UI State Update
        document.querySelectorAll('.chart-filter-btn').forEach(btn => {
            btn.classList.remove('bg-indigo-600', 'text-white', 'active', 'shadow-lg', 'shadow-indigo-600/20');
            btn.classList.add('text-slate-500');
        });
        const activeBtn = document.getElementById('btn-' + type);
        activeBtn.classList.remove('text-slate-500');
        activeBtn.classList.add('bg-indigo-600', 'text-white', 'active', 'shadow-lg', 'shadow-indigo-600/20');

        try {
            const response = await fetch(`/api/admin/revenue-stats?type=${type}&t=${Date.now()}`); // Added timestamp to prevent caching
            const { labels, data, dateRange } = await response.json();

            // Update range display with nice effect
            const rangeEl = document.getElementById('chart-date-range');
            rangeEl.style.opacity = '0';
            setTimeout(() => {
                rangeEl.textContent = dateRange;
                rangeEl.style.opacity = '1';
            }, 150);

            if (revenueChart) {
                revenueChart.destroy();
            }

            const ctx = document.getElementById('revenueChart').getContext('2d');

            // Premium Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.25)');
            gradient.addColorStop(0.5, 'rgba(99, 102, 241, 0.05)');
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu',
                        data: data,
                        fill: true,
                        backgroundColor: gradient,
                        borderColor: '#818cf8',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#6366f1',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7,
                        pointHoverBackgroundColor: '#6366f1',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 3,
                        pointRadius: 3,
                        pointHitRadius: 10,
                        tension: 0.45
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1200,
                        easing: 'easeOutQuart'
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleFont: { size: 13, weight: 'bold', family: 'Be Vietnam Pro' },
                            bodyFont: { size: 13, family: 'Be Vietnam Pro' },
                            padding: 16,
                            cornerRadius: 12,
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            displayColors: false,
                            boxShadow: '0 10px 25px -5px rgba(0, 0, 0, 0.4)',
                            callbacks: {
                                label: function (context) {
                                    return 'Doanh thu: ' + new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.03)', drawBorder: false },
                            ticks: {
                                color: '#64748b',
                                font: { size: 10, weight: '500', family: 'Be Vietnam Pro' },
                                padding: 10,
                                callback: function (value) {
                                    if (value >= 1000000) return (value / 1000000) + ' Tr';
                                    if (value >= 1000) return (value / 1000) + ' K';
                                    return value;
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#64748b',
                                font: { size: type === 'month' ? 8 : 10, weight: '700', family: 'Be Vietnam Pro' },
                                maxRotation: 0,
                                autoSkip: false,
                                maxTicksLimit: 31,
                                padding: 10
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading chart:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateRevenueChart('month');
    });
</script>

<style>
    #chart-date-range {
        transition: opacity 0.2s ease;
    }

    .chart-filter-btn.active {
        box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
    }

    body {
        background-color: #0b1120;
    }

    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-track {
        background: #0b1120;
    }

    ::-webkit-scrollbar-thumb {
        background: #1e293b;
        border-radius: 10px;
    }
</style>