<!-- Stats Row -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <!-- Active Orders -->
    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5 shadow-sm hover:border-slate-700 transition group">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-slate-500 text-sm font-medium mb-1">Đơn hàng đang chạy</p>
                <h3 class="text-2xl font-bold text-blue-400 group-hover:text-blue-300 transition">
                    <%= stats.active %>
                </h3>
            </div>
            <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500 group-hover:bg-blue-500/20 transition">
                <i class="ri-loader-4-line text-xl"></i>
            </div>
        </div>
    </div>
    <!-- Total Orders -->
    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5 shadow-sm hover:border-slate-700 transition group">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-slate-500 text-sm font-medium mb-1">Tổng đơn hàng</p>
                <h3 class="text-2xl font-bold text-white group-hover:text-indigo-400 transition">
                    <%= stats.total %>
                </h3>
            </div>
            <div class="p-2 bg-indigo-500/10 rounded-lg text-indigo-500 group-hover:bg-indigo-500/20 transition">
                <i class="ri-shopping-bag-3-line text-xl"></i>
            </div>
        </div>
    </div>
    <!-- Pending -->
    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5 shadow-sm hover:border-slate-700 transition group">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-slate-500 text-sm font-medium mb-1">Chờ xử lý</p>
                <h3 class="text-2xl font-bold text-amber-400 group-hover:text-amber-300 transition">
                    <%= stats.pending %>
                </h3>
            </div>
            <div class="p-2 bg-amber-500/10 rounded-lg text-amber-500 group-hover:bg-amber-500/20 transition">
                <i class="ri-time-line text-xl"></i>
            </div>
        </div>
    </div>
    <!-- Cancelled -->
    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5 shadow-sm hover:border-slate-700 transition group">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-slate-500 text-sm font-medium mb-1">Đã hủy</p>
                <h3 class="text-2xl font-bold text-rose-400 group-hover:text-rose-300 transition">
                    <%= stats.cancelled %>
                </h3>
            </div>
            <div class="p-2 bg-rose-500/10 rounded-lg text-rose-500 group-hover:bg-rose-500/20 transition">
                <i class="ri-close-circle-line text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Toolbar (Search & Filter) -->
<div
    class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 bg-slate-900/50 p-1.5 rounded-2xl border border-slate-800/50 backdrop-blur-sm shadow-sm">
    <!-- Search Input -->
    <div class="relative w-full sm:flex-1">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i
                class="ri-search-line text-slate-500 text-lg group-focus-within:text-indigo-400 transition duration-200"></i>
        </div>
        <input type="text" id="searchInput" placeholder="Tìm theo Order ID, User, Email..." value="<%= searchQuery %>"
            class="bg-transparent border-none text-slate-200 text-sm rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/50 block w-full pl-10 p-2.5 placeholder-slate-500 transition duration-200"
            onkeydown="if(event.key === 'Enter') applyFilters()">
    </div>

    <div class="flex items-center gap-2 w-full sm:w-auto">
        <!-- Status Filter -->
        <div
            class="flex items-center gap-2 bg-slate-800/50 rounded-xl px-2 border border-slate-700/50 focus-within:ring-2 focus-within:ring-indigo-500/50 focus-within:border-indigo-500/50 transition">
            <select id="statusFilter" onchange="applyFilters()"
                class="bg-transparent border-none text-slate-300 text-sm focus:outline-none focus:ring-0 p-2.5 w-full sm:w-auto cursor-pointer font-medium outline-none">
                <option value="all" class="bg-slate-950" <%=statusFilter==='all' ? 'selected' : '' %>>Tất cả trạng thái
                </option>
                <option value="completed" class="bg-slate-950 text-emerald-400" <%=statusFilter==='completed'
                    ? 'selected' : '' %>>Hoàn thành</option>
                <option value="cancelled" class="bg-slate-950 text-rose-400" <%=statusFilter==='cancelled' ? 'selected'
                    : '' %>>Đã hủy</option>
                <option value="expired" class="bg-slate-950 text-slate-400" <%=statusFilter==='expired' ? 'selected'
                    : '' %>>Hết hạn</option>
            </select>
        </div>

        <!-- Product Filter -->
        <div
            class="flex items-center gap-2 bg-slate-800/50 rounded-xl px-2 border border-slate-700/50 focus-within:ring-2 focus-within:ring-indigo-500/50 focus-within:border-indigo-500/50 transition">
            <select id="productFilter" onchange="applyFilters()"
                class="bg-transparent border-none text-slate-300 text-sm focus:outline-none focus:ring-0 p-2.5 w-full sm:w-auto cursor-pointer font-medium outline-none">
                <option value="" class="bg-slate-950" <%=productFilter==='' ? 'selected' : '' %>>All Products
                </option>
                <% allProducts.forEach(function(p) { %>
                    <option value="<%= p.id %>" class="bg-slate-950" <%=productFilter==p.id ? 'selected' : '' %>>
                        <%= p.name %>
                    </option>
                    <% }); %>
            </select>
        </div>

        <!-- Submit Button (Optional, but kept for consistency) -->
        <button onclick="applyFilters()"
            class="bg-indigo-600 hover:bg-indigo-500 text-white p-2.5 rounded-xl transition shadow-lg shadow-indigo-500/20 flex items-center justify-center aspect-square">
            <i class="ri-search-line text-lg w-5 h-5 flex items-center justify-center"></i>
        </button>

        <% if (user.role==='admin' ) { %>
            <button onclick="openModal()"
                class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2.5 rounded-xl transition shadow-lg shadow-indigo-500/20 text-sm font-medium whitespace-nowrap flex items-center gap-2">
                <i class="ri-add-line"></i>
                Tạo đơn hàng
            </button>
            <button id="bulkDeleteBtn" onclick="deleteSelected()" style="display: none;"
                class="bg-rose-600 hover:bg-rose-500 text-white px-4 py-2.5 rounded-xl transition shadow-lg shadow-rose-500/20 text-sm font-medium whitespace-nowrap flex items-center gap-2">
                <i class="ri-delete-bin-line"></i>
                <span>Xóa (<span id="selectedCount">0</span>)</span>
            </button>
            <% } %>
    </div>
</div>

<!-- Orders Table -->
<div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-sm flex flex-col">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead class="bg-slate-850 text-[10px] uppercase text-slate-400 font-semibold border-b border-slate-800">
                <tr>
                    <% if (user.role==='admin' ) { %>
                        <th class="px-6 py-4 w-[5%]">
                            <input type="checkbox" id="selectAll" onclick="toggleSelectAll()"
                                class="rounded bg-slate-800 border-slate-700 text-indigo-600 focus:ring-indigo-500 cursor-pointer w-4 h-4">
                        </th>
                        <% } %>
                            <th class="px-6 py-4 tracking-wider">Order ID</th>
                            <th class="px-6 py-4 tracking-wider">Người dùng</th>
                            <th class="px-6 py-4 tracking-wider">Gói/Sản phẩm</th>
                            <th class="px-6 py-4 text-center tracking-wider">Số tiền</th>
                            <th class="px-6 py-4 text-center tracking-wider">Trạng thái</th>
                            <th class="px-6 py-4 tracking-wider">Ngày tạo</th>
                            <th class="px-6 py-4 text-right tracking-wider">Ngày hết hạn</th>
                            <% if (user.role==='admin' ) { %>
                                <th class="px-6 py-4 text-right tracking-wider">Thao tác</th>
                                <% } %>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-800 text-sm" id="userTableBody">
                <% orders.forEach(function(order, index) { %>
                    <tr class="hover:bg-slate-800/50 transition duration-150 group">
                        <% if (user.role==='admin' ) { %>
                            <td class="px-6 py-4">
                                <input type="checkbox" value="<%= order.id %>"
                                    onclick="handleRowSelect(this, event, <%= index %>)"
                                    class="row-checkbox rounded bg-slate-800 border-slate-700 text-indigo-600 focus:ring-indigo-500 cursor-pointer w-4 h-4">
                            </td>
                            <% } %>
                                <td class="px-6 py-4">
                                    <span
                                        class="font-mono text-xs text-slate-400 bg-slate-950 px-2 py-1 rounded border border-slate-800 select-all">
                                        #<%= order.id %>
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="font-medium text-slate-200">
                                        <%= order.user ? order.user.full_name : 'Unknown' %>
                                    </div>
                                    <div class="text-xs text-slate-500">
                                        <%= order.user ? order.user.email : '-' %>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-indigo-400 font-medium">
                                        <%= order.package_name %>
                                    </div>
                                    <div class="text-xs text-slate-500">
                                        <%= order.product_name || 'General Product' %> • <%= order.duration %>
                                                days
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-center font-medium text-emerald-400">
                                    <%= new Intl.NumberFormat('vi-VN', { style: 'currency' , currency: 'VND'
                                        }).format(order.amount) %>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <% if (order.status==='completed' ) { %>
                                        <span
                                            class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                                            Hoàn thành
                                        </span>
                                        <% } else if (order.status==='cancelled' ) { %>
                                            <span
                                                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-rose-500/10 text-rose-400 border border-rose-500/20">
                                                Đã hủy
                                            </span>
                                            <% } else if (order.status==='expired' ) { %>
                                                <span
                                                    class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-700/50 text-slate-400 border border-slate-700">
                                                    Hết hạn
                                                </span>
                                                <% } else { %>
                                                    <span
                                                        class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-700/50 text-slate-400 border border-slate-700">
                                                        <%= order.status %>
                                                    </span>
                                                    <% } %>
                                </td>
                                <td class="px-6 py-4 text-slate-500 text-xs">
                                    <%= new Date(order.createdAt).toLocaleDateString('vi-VN') %>
                                        <div class="text-[10px] text-slate-600">
                                            <%= new Date(order.createdAt).toLocaleTimeString('vi-VN', { hour: '2-digit'
                                                , minute: '2-digit' }) %>
                                        </div>
                                </td>
                                <td class="px-6 py-4 text-right text-xs">
                                    <div class="text-indigo-400 font-medium">
                                        <%= order.expiry_date ? new Date(order.expiry_date).toLocaleDateString('vi-VN')
                                            : 'Vĩnh viễn' %>
                                    </div>
                                    <% if (order.expiry_date && new Date(order.expiry_date) < new Date()) { %>
                                        <div class="text-[10px] text-rose-500/70">Hết hạn</div>
                                        <% } %>
                                </td>
                                <% if (user.role==='admin' ) { %>
                                    <td class="px-6 py-4 text-right">
                                        <div class="flex items-center justify-end gap-2">
                                            <button
                                                onclick="openEditModal('<%= order.id %>', '<%= order.status %>', '<%= order.amount %>', '<%= order.payment_method || '' %>')"
                                                class="p-1.5 rounded-lg text-slate-400 hover:text-indigo-400 hover:bg-slate-800 transition"
                                                title="Edit">
                                                <i class="ri-edit-line"></i>
                                            </button>
                                            <a href="/orders/delete/<%= order.id %>"
                                                onclick="return confirm('Bạn có chắc chắn muốn xóa đơn hàng #<%= order.id %>?')"
                                                class="p-1.5 rounded-lg text-slate-400 hover:text-rose-400 hover:bg-slate-800 transition"
                                                title="Delete">
                                                <i class="ri-delete-bin-line"></i>
                                            </a>
                                        </div>
                                    </td>
                                    <% } %>
                    </tr>
                    <% }); %>
                        <% if (orders.length===0) { %>
                            <tr>
                                <td colspan="<%= user.role === 'admin' ? 8 : 7 %>"
                                    class="px-6 py-12 text-center text-slate-500">
                                    <p>No orders found.</p>
                                </td>
                            </tr>
                            <% } %>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <% if (totalPages> 1) { %>
        <%- include('../partials/pagination', { path: '/admin/orders' , query: query, currentPage: currentPage,
            totalPages: totalPages }) %>
            <% } %>
</div>


<% if (user.role==='admin' ) { %>
    <!-- Create Order Modal -->
    <div id="orderModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div
                    class="relative transform overflow-hidden rounded-xl bg-slate-900 border border-slate-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">

                    <div class="px-6 py-5 border-b border-slate-800 flex justify-between items-center">
                        <h3 class="text-base font-semibold leading-6 text-white">Tạo đơn hàng mới</h3>
                        <button type="button" onclick="closeModal()" class="text-slate-400 hover:text-white transition">
                            <i class="ri-close-line text-xl"></i>
                        </button>
                    </div>

                    <form action="/orders/create" method="POST" class="p-6 space-y-5">

                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1.5">Chọn người dùng</label>
                            <select name="user_id" required
                                class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                                <% allUsers.forEach(function(u) { %>
                                    <option value="<%= u.id %>">
                                        <%= u.full_name %> (<%= u.email %>)
                                    </option>
                                    <% }); %>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1.5">Chọn gói</label>
                            <select name="package_id" required
                                class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                                <% allPackages.forEach(function(pkg) { %>
                                    <option value="<%= pkg.id %>">
                                        [<%= pkg.product ? pkg.product.name : 'Unknown' %>] <%= pkg.name %> - <%= new
                                                    Intl.NumberFormat('vi-VN', { style: 'currency' , currency: 'VND'
                                                    }).format(pkg.original_price) %>/tháng
                                    </option>
                                    <% }); %>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1.5">Thời hạn</label>
                            <select name="duration" required
                                class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                                <option value="1">1 Tháng</option>
                                <option value="3">3 Tháng</option>
                                <option value="6">6 Tháng</option>
                                <option value="12">1 Năm</option>
                            </select>
                        </div>

                        <div class="pt-2 flex justify-end gap-3">
                            <button type="button" onclick="closeModal()"
                                class="px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 transition">Hủy</button>
                            <button type="submit"
                                class="px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20 transition">Tạo
                                đơn hàng</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div id="editOrderModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm transition-opacity" onclick="closeEditModal()">
        </div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div
                    class="relative transform overflow-hidden rounded-xl bg-slate-900 border border-slate-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">

                    <div class="px-6 py-5 border-b border-slate-800 flex justify-between items-center">
                        <h3 class="text-base font-semibold leading-6 text-white">Sửa đơn hàng</h3>
                        <button type="button" onclick="closeEditModal()"
                            class="text-slate-400 hover:text-white transition">
                            <i class="ri-close-line text-xl"></i>
                        </button>
                    </div>

                    <form action="/orders/update" method="POST" class="p-6 space-y-5">
                        <input type="hidden" name="id" id="edit_id">

                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1.5">Trạng thái</label>
                            <select name="status" id="edit_status"
                                class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                                <option value="pending">Chờ xử lý</option>
                                <option value="completed">Hoàn thành</option>
                                <option value="cancelled">Đã hủy</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1.5">Số tiền (VND)</label>
                            <input type="number" name="amount" id="edit_amount" required
                                class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1.5">Phương thức thanh
                                toán</label>
                            <input type="text" name="payment_method" id="edit_payment_method"
                                class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50"
                                placeholder="ví dụ: Chuyển khoản, Số dư ví">
                        </div>

                        <div class="pt-2 flex justify-end gap-3">
                            <button type="button" onclick="closeEditModal()"
                                class="px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 transition">Hủy</button>
                            <button type="submit"
                                class="px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20 transition">Lưu
                                thay đổi</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <% } %>

        <script src="/js/admin-core.js"></script>
        <script>
            // Initialize Shared Logic
            new TableManager({
                deleteUrl: '/orders/delete-bulk',
                confirmMessage: 'Bạn có chắc chắn muốn xóa {count} đơn hàng? Hành động này không thể hoàn tác.'
            });

            // Filter Logic
            function applyFilters() {
                const search = document.getElementById('searchInput').value;
                const status = document.getElementById('statusFilter').value;
                const product = document.getElementById('productFilter').value;
                const url = new URL(window.location.href);
                url.searchParams.set('page', 1);
                if (search) url.searchParams.set('search', search); else url.searchParams.delete('search');
                if (status !== 'all') url.searchParams.set('status', status); else url.searchParams.delete('status');
                if (product) url.searchParams.set('product_id', product); else url.searchParams.delete('product_id'); // ID param used for name searching
                window.location.href = url.toString();
            }

            function changePage(page) {
                const url = new URL(window.location.href);
                url.searchParams.set('page', page);
                window.location.href = url.toString();
            }

            function openModal() { document.getElementById('orderModal').classList.remove('hidden'); }
            function closeModal() { document.getElementById('orderModal').classList.add('hidden'); }

            function openEditModal(id, status, amount, paymentMethod) {
                document.getElementById('edit_id').value = id;
                document.getElementById('edit_status').value = status;
                document.getElementById('edit_amount').value = Math.floor(amount); // Remove decimals if any
                document.getElementById('edit_payment_method').value = paymentMethod || '';

                document.getElementById('editOrderModal').classList.remove('hidden');
            }

            function closeEditModal() {
                document.getElementById('editOrderModal').classList.add('hidden');
            }
        </script>
        <style>
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(5px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>